<!DOCTYPE html>

<html>
<head>
  <title>jquery.modalDialog.history.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="breakpoints.html">
                breakpoints.js
              </a>
            
              
              <a class="source" href="date-parse.html">
                date-parse.js
              </a>
            
              
              <a class="source" href="jquery.breakpoints.html">
                jquery.breakpoints.js
              </a>
            
              
              <a class="source" href="jquery.calcRestrainedPos.html">
                jquery.calcRestrainedPos.js
              </a>
            
              
              <a class="source" href="jquery.clientRect.html">
                jquery.clientRect.js
              </a>
            
              
              <a class="source" href="jquery.contentSize.html">
                jquery.contentSize.js
              </a>
            
              
              <a class="source" href="jquery.cookies.html">
                jquery.cookies.js
              </a>
            
              
              <a class="source" href="jquery.css.html">
                jquery.css.js
              </a>
            
              
              <a class="source" href="jquery.customEvent.html">
                jquery.customEvent.js
              </a>
            
              
              <a class="source" href="jquery.delimitedString.html">
                jquery.delimitedString.js
              </a>
            
              
              <a class="source" href="jquery.disableEvent.html">
                jquery.disableEvent.js
              </a>
            
              
              <a class="source" href="jquery.hostIframe.html">
                jquery.hostIframe.js
              </a>
            
              
              <a class="source" href="jquery.hoverDelay.html">
                jquery.hoverDelay.js
              </a>
            
              
              <a class="source" href="jquery.htmlEncode.html">
                jquery.htmlEncode.js
              </a>
            
              
              <a class="source" href="jquery.imageSize.html">
                jquery.imageSize.js
              </a>
            
              
              <a class="source" href="jquery.isVisibleKeyCode.html">
                jquery.isVisibleKeyCode.js
              </a>
            
              
              <a class="source" href="jquery.menu.html">
                jquery.menu.js
              </a>
            
              
              <a class="source" href="jquery-menu-exampleskin.html">
                jquery-menu-exampleskin.js
              </a>
            
              
              <a class="source" href="jquery.modalDialog.deviceFixes.html">
                jquery.modalDialog.deviceFixes.js
              </a>
            
              
              <a class="source" href="jquery.modalDialog.getSettings.html">
                jquery.modalDialog.getSettings.js
              </a>
            
              
              <a class="source" href="jquery.modalDialog.header.html">
                jquery.modalDialog.header.js
              </a>
            
              
              <a class="source" href="jquery.modalDialog.history.html">
                jquery.modalDialog.history.js
              </a>
            
              
              <a class="source" href="jquery.modalDialog.html">
                jquery.modalDialog.js
              </a>
            
              
              <a class="source" href="jquery.modalDialog.unobtrusive.html">
                jquery.modalDialog.unobtrusive.js
              </a>
            
              
              <a class="source" href="jquery.modalDialog.userAgent.html">
                jquery.modalDialog.userAgent.js
              </a>
            
              
              <a class="source" href="jquery.modalDialogContent.header.html">
                jquery.modalDialogContent.header.js
              </a>
            
              
              <a class="source" href="jquery.modalDialogContent.html">
                jquery.modalDialogContent.js
              </a>
            
              
              <a class="source" href="jquery.msAjax.html">
                jquery.msAjax.js
              </a>
            
              
              <a class="source" href="jquery.noPageScroll.html">
                jquery.noPageScroll.js
              </a>
            
              
              <a class="source" href="jquery.ns.html">
                jquery.ns.js
              </a>
            
              
              <a class="source" href="jquery.partialLoad.html">
                jquery.partialLoad.js
              </a>
            
              
              <a class="source" href="jquery.postMessage.html">
                jquery.postMessage.js
              </a>
            
              
              <a class="source" href="jquery.proxyAll.html">
                jquery.proxyAll.js
              </a>
            
              
              <a class="source" href="jquery.queryString.html">
                jquery.queryString.js
              </a>
            
              
              <a class="source" href="jquery.richTooltip.html">
                jquery.richTooltip.js
              </a>
            
              
              <a class="source" href="jquery.scrollAnchor.html">
                jquery.scrollAnchor.js
              </a>
            
              
              <a class="source" href="jquery.uncomment.html">
                jquery.uncomment.js
              </a>
            
              
              <a class="source" href="jquery.url.html">
                jquery.url.js
              </a>
            
              
              <a class="source" href="pointy.gestures.html">
                pointy.gestures.js
              </a>
            
              
              <a class="source" href="pointy.html">
                pointy.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>jquery.modalDialog.history.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* globals History */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO: Need to support stacking dialogs:
i.e. ?dialogs=#foo,ajax:/foo.html,iframe:/foo.html
TODO require history.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($)</span> </span>{
    <span class="hljs-keyword">var</span> DEFAULT_DIALOG_PARAM_NAME = <span class="hljs-string">"sdialogid"</span>;
    <span class="hljs-keyword">var</span> _dialogParamName;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Enables the history plugin, and returns a promise which
resolves when either the dialog specified in the URL is opened,
or if there is no dialog specified, immediately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.modalDialog.enableHistory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dialogParamName)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Ensure enableHistory isn’t called twice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (_historyEnabled) {
            <span class="hljs-keyword">return</span>;
        }

        _historyEnabled = <span class="hljs-literal">true</span>;

        _dialogParamName = dialogParamName || DEFAULT_DIALOG_PARAM_NAME;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Disable history for any dialogs that are currently open.
This is to ensure that we don’t initialize with the URL and
dialogs in an incompatible state. This probably would happen
if someone opened a dialog when the DOM loaded, in which
case it was meant to be part of the initial page state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        disableHistoryForOpenDialogs();

        <span class="hljs-keyword">var</span> deferred = <span class="hljs-keyword">new</span> $.Deferred();

        updateFromUrl(<span class="hljs-literal">true</span>) <span class="hljs-comment">// Disable animation when the dialog state is restored from the URL</span>
            .then(
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">try</span> {
                        $.modalDialog.onopen.add(openHandler);
                        $.modalDialog.onclose.add(closeHandler);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>History.pushState(null, document.title, document.location.href);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                        History.Adapter.bind(<span class="hljs-built_in">window</span>, <span class="hljs-string">"statechange"</span>, popstateHandler);

                        deferred.resolve();
                    } <span class="hljs-keyword">catch</span> (ex) {
                        deferred.reject(ex);
                    }
                },
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ex)</span> </span>{
                    deferred.reject(ex);
                });

        <span class="hljs-keyword">return</span> deferred;
    };

    $.modalDialog.isHistoryEnabled = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> _historyEnabled;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Handle history.js in hash mode for browser that don’t support pushState</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> currentQueryStringOrHash = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (History.emulated.pushState &amp;&amp; <span class="hljs-built_in">window</span>.location.hash) {
            <span class="hljs-keyword">var</span> qPos = <span class="hljs-built_in">window</span>.location.hash.indexOf(<span class="hljs-string">"?"</span>);
            <span class="hljs-keyword">if</span> (qPos &gt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> $.deparam(<span class="hljs-built_in">window</span>.location.hash.substr(qPos));
            }
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.location.search) {
            <span class="hljs-keyword">return</span> $.currentQueryString();
        }

        <span class="hljs-keyword">return</span> {};
    };

    <span class="hljs-keyword">var</span> disableHistoryForOpenDialogs = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> parent = $.modalDialog.getCurrent();

        <span class="hljs-keyword">while</span> (parent) {
            <span class="hljs-keyword">if</span> (parent) {
                parent.settings.enableHistory = <span class="hljs-literal">false</span>;
            }

            parent = parent.getParent();
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>If history is disabled for any dialog in the stack, it should be disabled
for all of them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> isHistoryEnabled = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dialog)</span> </span>{
        <span class="hljs-keyword">var</span> parent = dialog;

        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> (parent &amp;&amp; !parent.settings.enableHistory) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }

            parent = parent.getParent();

        } <span class="hljs-keyword">while</span> (parent);

        <span class="hljs-keyword">return</span> _historyEnabled;
    };

    <span class="hljs-keyword">var</span> _pageIsAtInitialState = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> _stateAlreadyProcessed = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> _disableHandlers = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> _historyEnabled = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> getDialogParams = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dialog)</span> </span>{
        <span class="hljs-keyword">var</span> dialogParams = {
            dialogType: <span class="hljs-string">"node"</span>,
            dialogId: <span class="hljs-literal">null</span>
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Get the ID of the selected element (for node dialogs)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (dialog.settings.content) {
            <span class="hljs-keyword">var</span> id = $(dialog.settings.content).prop(<span class="hljs-string">"id"</span>);
            <span class="hljs-keyword">if</span> (!id) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"The specified content node has no ID, and cannot be serialized to a URL parameter."</span>);
            }

            dialogParams.dialogId = <span class="hljs-string">"#"</span> + id;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>If its not a node dialog, use the URL as the ID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!dialogParams.dialogId &amp;&amp; dialog.settings.url) {
            dialogParams.dialogType = dialog.settings.ajax ? <span class="hljs-string">"ajax"</span> : <span class="hljs-string">"iframe"</span>;
            dialogParams.dialogId = dialog.settings.url;
        }

        <span class="hljs-keyword">return</span> dialogParams;
    };

    <span class="hljs-keyword">var</span> getDialogSettingsFromParams = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dialogParams)</span> </span>{
        <span class="hljs-keyword">var</span> settings = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (dialogParams.dialogType == <span class="hljs-string">"iframe"</span>) {
            settings = {
                url: dialogParams.dialogId
            };
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dialogParams.dialogType == <span class="hljs-string">"ajax"</span>) {
            settings = {
                ajax: <span class="hljs-literal">true</span>,
                url: dialogParams.dialogId
            };
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> $content;
            <span class="hljs-keyword">try</span> {
                $content = $(dialogParams.dialogId);
            } <span class="hljs-keyword">catch</span> (ex) {}

            <span class="hljs-keyword">if</span> ($content &amp;&amp; $content.length &gt; <span class="hljs-number">0</span>) {
                settings = $.modalDialog.getSettings($content);
                settings.content = $content;
            }
        }

        <span class="hljs-keyword">return</span> settings;
    };

    <span class="hljs-keyword">var</span> doParamsMatchDialog = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dialogParams, dialog)</span> </span>{
        <span class="hljs-keyword">var</span> d1 = getDialogParams(dialog);

        <span class="hljs-keyword">return</span> d1.dialogType == dialogParams.dialogType &amp;&amp;
            d1.dialogId == dialogParams.dialogId;
    };

    <span class="hljs-keyword">var</span> encodeDialogId = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(s)</span> </span>{
        <span class="hljs-keyword">return</span> s.replace(<span class="hljs-string">"#"</span>, <span class="hljs-string">"-hash-"</span>);
    };

    <span class="hljs-keyword">var</span> decodeDialogId = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(s)</span> </span>{
        <span class="hljs-keyword">return</span> s.replace(<span class="hljs-string">"-hash-"</span>, <span class="hljs-string">"#"</span>);
    };

    <span class="hljs-keyword">var</span> parseDialogParams = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
        <span class="hljs-keyword">if</span> (!data) {
            <span class="hljs-keyword">return</span> [];
        }

        <span class="hljs-keyword">var</span> items = data.split(<span class="hljs-string">" "</span>);

        <span class="hljs-keyword">return</span> $.map(items, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{
            <span class="hljs-keyword">var</span> delimPos = item.indexOf(<span class="hljs-string">"_"</span>);

            <span class="hljs-keyword">if</span> (delimPos &lt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid dialog parameters: "</span> + item);
            }

            <span class="hljs-keyword">return</span> {
                dialogType: item.substr(<span class="hljs-number">0</span>, delimPos),
                dialogId: decodeDialogId(item.substr(delimPos + <span class="hljs-number">1</span>))
            };
        });
    };

    <span class="hljs-keyword">var</span> encodeDialogParams = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dialogParamsList)</span> </span>{
        <span class="hljs-keyword">return</span> $.map(dialogParamsList, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{
            <span class="hljs-keyword">return</span> item.dialogType + <span class="hljs-string">"_"</span> + encodeDialogId(item.dialogId);
        })
            .join(<span class="hljs-string">" "</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Handler for dialogs opening</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> openHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Hook to ensure the history handler doesn’t run infinitely
when the dialog was opened by the history plugin itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (_disableHandlers) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (!isHistoryEnabled(<span class="hljs-keyword">this</span>)) {
            <span class="hljs-keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Build a querystring to encode the open state of the dialog</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">var</span> dialogParams = getDialogParams(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>If there’s an existing open dialog, encode the parameters for this dialog after it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> qs = currentQueryStringOrHash();
        <span class="hljs-keyword">var</span> dialogParamsList = parseDialogParams(qs[_dialogParamName]);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Verify that the level of the dialog matches the number of items in the dialogParamsList</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">this</span>.level + <span class="hljs-number">1</span>) &lt;= dialogParamsList.length) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"The number of dialogParams in the URL doesn't match the number of open dialogs. Not updating history."</span>);
        }

        dialogParamsList.push(dialogParams);
        qs[_dialogParamName] = encodeDialogParams(dialogParamsList);

        <span class="hljs-keyword">var</span> url = $.appendQueryString(<span class="hljs-built_in">document</span>.location.pathname, qs);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Hook to notify the popstate handler that this URL change was triggered internally,
and the dialog is already open, so it shouldn’t do any more work.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _stateAlreadyProcessed = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Update the URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        History.pushState(<span class="hljs-literal">null</span>, <span class="hljs-built_in">document</span>.title, url);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Mark the page as not in its initial state so the close handler will know if
it should add a history entry when closing dialogs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _pageIsAtInitialState = <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Handler which fires when dialogs are closed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> closeHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (_disableHandlers) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.settings.enableHistory === <span class="hljs-literal">false</span>) {
            <span class="hljs-keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>If the page is in its initial state (just loaded), then closing a dialog should
create a new history entry so the back button will open the dialog again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (_pageIsAtInitialState) {
            <span class="hljs-keyword">var</span> qs = currentQueryStringOrHash();
            <span class="hljs-keyword">var</span> dialogParamsList = parseDialogParams(qs[_dialogParamName]);
            <span class="hljs-keyword">var</span> poppedParams = dialogParamsList.pop();

            <span class="hljs-keyword">if</span> (!doParamsMatchDialog(poppedParams, <span class="hljs-keyword">this</span>)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Closed dialog does not match URL parameters: "</span> + poppedParams.dialogType + <span class="hljs-string">","</span> + poppedParams.dialogId + <span class="hljs-string">". History not updated."</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>TODO: verify that the dialog params popped off match the current dialog
clean up if not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">if</span> (dialogParamsList.length === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">delete</span> qs[_dialogParamName];
            } <span class="hljs-keyword">else</span> {
                qs[_dialogParamName] = encodeDialogParams(dialogParamsList);
            }

            <span class="hljs-keyword">var</span> url = $.appendQueryString(<span class="hljs-built_in">document</span>.location.pathname, qs);

            History.pushState(<span class="hljs-literal">null</span>, <span class="hljs-built_in">document</span>.title, url);
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If the page isn’t in its initial state, then closing a dialog should go back
one entry in history.</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Since we’re in a dialog close handler, we don’t want to re-trigger a dialog close
when the popstate event fires. This prevents an infinite loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            _stateAlreadyProcessed = <span class="hljs-literal">true</span>;

            History.back();
        }

        _pageIsAtInitialState = <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Looks for changes in the URL and opens or closes dialogs accordingly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> popstateHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If the history plugin triggered the URL change itself,
then the UI has been updated already, and we shouldn’t update anything.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (_stateAlreadyProcessed) {
            _stateAlreadyProcessed = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span>;
        }

        updateFromUrl();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Listen to URL changes and open/close dialogs accordingly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> updateFromUrl = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(disableAnimation)</span> </span>{
        <span class="hljs-keyword">var</span> deferred = <span class="hljs-keyword">new</span> $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>An array of parsed dialog parameters from the URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> dialogParamsList = parseDialogParams(currentQueryStringOrHash()[_dialogParamName]);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Figure out the topmost dialog so it can be checked against the number of dialogs specified in the URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> topmostDialog = $.modalDialog.getCurrent();
        <span class="hljs-keyword">var</span> topmostStackPos = topmostDialog ? topmostDialog.level + <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;

        <span class="hljs-keyword">if</span> (dialogParamsList.length === topmostStackPos) {
            deferred.resolve();
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>If there are more dialogParams in the URL than dialogs displayed,
open them in order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> openDialogsUntilUrlMatches = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (dialogParamsList.length &gt; topmostStackPos) {
                <span class="hljs-keyword">var</span> dialogParams = dialogParamsList[topmostStackPos];

                <span class="hljs-keyword">var</span> settings = getDialogSettingsFromParams(dialogParams);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>validate settings are correct</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!settings) {
                    _disableHandlers = <span class="hljs-literal">false</span>;

                    deferred.reject(<span class="hljs-string">"Unable to create dialog settings from dialogId in URL: "</span> + dialogParams.dialogType + <span class="hljs-string">","</span> + dialogParams.dialogId);
                    <span class="hljs-keyword">return</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Try to reuse an existing, matching dialog if possible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> dialog = $.modalDialog.getExisting(settings);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>If it doesn’t exist, create a new one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!dialog) {
                    dialog = $.modalDialog.create(settings);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Disable dialog open/close handlers set by this history plugin,
because we’re currently reading the URL and updating the dialogs.
If the handlers were enabled, we’d get infinite looping.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                _disableHandlers = <span class="hljs-literal">true</span>;

                dialog.open(disableAnimation) <span class="hljs-comment">// Disable animation when the dialog state is being restored from the URL on page init</span>
                    .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Recurse until all dialogs embedded in the URL are open</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        topmostStackPos++;
                        <span class="hljs-keyword">try</span> {
                            openDialogsUntilUrlMatches();
                        } <span class="hljs-keyword">catch</span> (ex) {
                            deferred.reject(ex);
                        }
                    });
            } <span class="hljs-keyword">else</span> {
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        deferred.resolve();
                        _disableHandlers = <span class="hljs-literal">false</span>;
                    },
                    <span class="hljs-number">0</span>);
            }
        };

        <span class="hljs-keyword">if</span> (dialogParamsList.length &gt; topmostStackPos) {
            openDialogsUntilUrlMatches();
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>If there are fewer dialogParams in the URL than in dialogs displayed,
close them until they match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> closeDialogsUntilUrlMatches = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (dialogParamsList.length &lt; topmostStackPos) {
                <span class="hljs-keyword">var</span> currentDialog = $.modalDialog.getCurrent();
                <span class="hljs-keyword">if</span> (currentDialog) {
                    <span class="hljs-keyword">if</span> (!currentDialog.settings.enableHistory) {
                        deferred.resolve();
                        _disableHandlers = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">return</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Disable dialog open/close handlers set by this history plugin,
because we’re currently reading the URL and updating the dialogs.
If the handlers were enabled, we’d get infinite looping.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    _disableHandlers = <span class="hljs-literal">true</span>;

                    currentDialog.close()
                        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            topmostStackPos--;

                            <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Recurse until all dialogs not in the URL are closed </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                closeDialogsUntilUrlMatches();
                            } <span class="hljs-keyword">catch</span> (ex) {
                                deferred.reject(ex);
                            }
                        });
                } <span class="hljs-keyword">else</span> {
                    _disableHandlers = <span class="hljs-literal">false</span>;
                    deferred.reject(<span class="hljs-string">"There was a mismatch between the URL and the current open dialog stack"</span>);
                }
            } <span class="hljs-keyword">else</span> {
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    deferred.resolve();
                    _disableHandlers = <span class="hljs-literal">false</span>;
                });
            }
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Close open dialogs that don’t match the URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (dialogParamsList.length &lt; topmostStackPos) {
            closeDialogsUntilUrlMatches();
        }

        <span class="hljs-keyword">return</span> deferred;
    };

    <span class="hljs-comment">/* test-code */</span>
    $.modalDialog._historyPrivate = {
        disableHistoryForOpenDialogs: disableHistoryForOpenDialogs
    };
    <span class="hljs-comment">/* end-test-code */</span>

})(jQuery);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
